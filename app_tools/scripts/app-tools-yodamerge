
#!/bin/bash

if [ $# -lt 1 ]; then
    echo "Usage: $0 <folder> [nproc]"
    echo "  <folder> : Directory containing subfolders with YODA files"
    echo "  [nproc]  : Number of parallel jobs (default: 4)"
    echo "Merges all .yoda.gz files in subdirectories into a single .yoda file in each subdirectory."
    exit 1
fi

PREFIX="${1%/}"
NPROC="${2:-4}"

merge_dir() {
    dir="$1"
    YODA=$(basename "$dir")
    OUTFILE="$dir/${YODA}.yoda"

    if [ -f "$OUTFILE" ]; then
        echo "Skipping $dir: $OUTFILE already exists."
        return
    fi

    mapfile -t FILES < <(find "$dir" -mindepth 2 -maxdepth 2 -type f \( -name '*.yoda' -o -name '*.yoda.gz' \))

    if [ "${#FILES[@]}" -eq 0 ]; then
        echo "No .yoda.gz/.yoda files found in subdirectories of $dir"
    else
        echo "Merging YODA files into $OUTFILE..."
        if command -v yodamerge >/dev/null 2>&1; then
            yodamerge "${FILES[@]}" -o "$OUTFILE"
        else
            ~/Programs/local/bin/yodamerge "${FILES[@]}" -o "$OUTFILE"
        fi
    fi
}

export -f merge_dir

if [ -d "$PREFIX" ]; then
    find "$PREFIX" -mindepth 1 -maxdepth 1 -type d | xargs -n 1 -P "$NPROC" bash -c 'merge_dir "$0"'
else
    echo "No directory named $PREFIX!"
    exit 1
fi
