
#!/bin/bash

if [ $# -lt 1 ]; then
    echo "Usage: $0 <folder1> [<folder2> ...] [nproc]"
    echo "  <folder> : Directory containing subfolders with YODA files"
    echo "  [nproc]  : Number of parallel jobs (default: 4)"
    echo "If subdirectories have their own subfolders, merges all .yoda/.yoda.gz files from nested subdirectories into a single .yoda file in each subdirectory."
    echo "If subdirectories do not have subfolders, merges all .yoda/.yoda.gz files from all subdirectories into a single .yoda file in the parent folder."
    exit 1
fi

is_number() {
    [[ "$1" =~ ^[0-9]+$ ]]
}

FOLDERS=()
NPROC=4

for arg in "$@"; do
    if is_number "$arg" && [ "$arg" = "${@: -1}" ]; then
        NPROC="$arg"
    else
        FOLDERS+=("$arg")
    fi
done

if [ ${#FOLDERS[@]} -eq 0 ]; then
    echo "Error: No folders provided!"
    exit 1
fi

merge_dir() {
    dir="$1"
    YODA=$(basename "$dir")
    OUTFILE="$dir/${YODA}.yoda"
    if [ -f "$OUTFILE" ]; then
        echo "Skipping $dir: $OUTFILE already exists."
        return
    fi

    mapfile -t FILES < <(find "$dir" -mindepth 2 -maxdepth 2 -type f \( -name '*.yoda' -o -name '*.yoda.gz' \))

    if [ "${#FILES[@]}" -eq 0 ]; then
        echo "No .yoda.gz/.yoda files found in subdirectories of $dir"
    else
        echo "Merging YODA files into $OUTFILE..."
        if command -v yodamerge >/dev/null 2>&1; then
            yodamerge "${FILES[@]}" -o "$OUTFILE"
        else
            ~/Programs/local/bin/yodamerge "${FILES[@]}" -o "$OUTFILE"
        fi
    fi
}

export -f merge_dir

process_folder() {
    PREFIX="${1%/}"
    if [ ! -d "$PREFIX" ]; then
        echo "Warning: No directory named $PREFIX! Skipping..."
        return 1
    fi

    echo "Processing folder: $PREFIX with $NPROC parallel jobs..."

    has_nested_subdirs=false
    for dir in "$PREFIX"/*; do
        if [ -d "$dir" ] && [ "$(find "$dir" -mindepth 1 -maxdepth 1 -type d | wc -l)" -gt 0 ]; then
            has_nested_subdirs=true
            break
        fi
    done

    if [ "$has_nested_subdirs" = true ]; then
        find "$PREFIX" -mindepth 1 -maxdepth 1 -type d | xargs -n 1 -P "$NPROC" bash -c 'merge_dir "$0"'
    else
        YODA=$(basename "$PREFIX")
        OUTFILE="$PREFIX/${YODA}.yoda"
        
        if [ -f "$OUTFILE" ]; then
            echo "Skipping: $OUTFILE already exists."
        else
            mapfile -t FILES < <(find "$PREFIX" -mindepth 2 -maxdepth 2 -type f \( -name '*.yoda' -o -name '*.yoda.gz' \))
            
            if [ "${#FILES[@]}" -eq 0 ]; then
                echo "No .yoda/.yoda.gz files found in subdirectories of $PREFIX"
            else
                echo "Merging YODA files from all subdirectories into $OUTFILE..."
                if command -v yodamerge >/dev/null 2>&1; then
                    yodamerge "${FILES[@]}" -o "$OUTFILE"
                else
                    ~/Programs/local/bin/yodamerge "${FILES[@]}" -o "$OUTFILE"
                fi
            fi
        fi
    fi
}

for folder in "${FOLDERS[@]}"; do
    process_folder "$folder"
done
